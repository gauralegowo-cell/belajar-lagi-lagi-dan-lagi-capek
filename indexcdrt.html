<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisis Kelapa Sawit ðŸŒ´</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root {
            /* Palet Warna Hijau */
            --hijau-primer: #007041; /* Hijau Sawit Tua */
            --hijau-sekunder: #4CAF50; /* Hijau Cerah */
            --hijau-aksen: #8BC34A; /* Hijau Lime Muda */
            --latar-belakang: #F4F6F8;
            --kartu-latar: #FFFFFF;
            --bayangan-kartu: 0 4px 8px rgba(0, 0, 0, 0.1);
            --teks-gelap: #333333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--latar-belakang);
            color: var(--teks-gelap);
            line-height: 1.6;
        }

        /* Struktur Layout */
        #dashboard-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background-color: var(--hijau-primer);
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: var(--bayangan-kartu);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        header .icon-palm {
            font-size: 2em;
            margin-right: 10px;
        }

        /* Kartu Info */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--kartu-latar);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--bayangan-kartu);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: var(--hijau-primer);
            margin-top: 0;
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .card .value {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--teks-gelap);
        }

        /* Area Grafik */
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Grafik utama lebih besar dari pie */
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-full, .chart-grid > div {
            background-color: var(--kartu-latar);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--bayangan-kartu);
        }

        /* Input dan Filter */
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--bayangan-kartu);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .controls label {
            font-weight: bold;
            color: var(--hijau-primer);
        }

        .controls input[type="file"], .controls select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .button, button {
            background-color: var(--hijau-sekunder);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: bold;
        }

        .button:hover, button:hover {
            background-color: var(--hijau-aksen);
        }

        /* Tabel Data */
        #data-table-section {
            background-color: var(--kartu-latar);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--bayangan-kartu);
            overflow-x: auto;
        }

        #data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #data-table th, #data-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        #data-table th {
            background-color: var(--hijau-primer);
            color: white;
            cursor: pointer;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div id="dashboard-container">
        <header>
            <h1><span class="icon-palm"><i class="fas fa-seedling"></i></span> Dashboard Operasi Kelapa Sawit</h1>
            <div class="user-info">
                <i class="fas fa-user-circle"></i> Manajer / Teknisi Pabrik
            </div>
        </header>

        <div class="controls">
            <label for="csvFileInput"><i class="fas fa-upload"></i> Unggah Data (CSV):</label>
            <input type="file" id="csvFileInput" accept=".csv">
            <label for="filterBulan">Filter Bulan:</label>
            <select id="filterBulan" disabled>
                <option value="">Semua</option>
                </select>
            <button id="downloadBtn" class="button" disabled><i class="fas fa-download"></i> Unduh Data</button>
        </div>

        <div class="info-cards">
            <div class="card">
                <h3><i class="fas fa-industry"></i> Total Produksi (Ton)</h3>
                <div class="value" id="produksi-total">N/A</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-money-bill-wave"></i> Total Penjualan (Rp)</h3>
                <div class="value" id="penjualan-total">N/A</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-ruler-combined"></i> Total Area (Ha)</h3>
                <div class="value" id="area-total">N/A</div>
            </div>
            <div class="card">
                <h3><i class="fas fa-tag"></i> Harga Rata-rata (Rp/Kg)</h3>
                <div class="value" id="harga-rata">N/A</div>
            </div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-full">
                <h3><i class="fas fa-chart-line"></i> Tren Produksi dan Harga per Bulan</h3>
                <canvas id="lineChart"></canvas>
            </div>
            <div>
                <h3><i class="fas fa-chart-pie"></i> Distribusi Area (Ha)</h3>
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <div class="chart-full">
            <h3><i class="fas fa-chart-bar"></i> Perbandingan Penjualan per Lokasi</h3>
            <canvas id="barChart"></canvas>
        </div>

        <div id="data-table-section">
            <h3><i class="fas fa-table"></i> Data Produksi dan Penjualan</h3>
            <div style="margin-bottom: 10px;">
                <label for="tableSearch">Cari:</label>
                <input type="text" id="tableSearch" placeholder="Filter di sini..." style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <table id="data-table">
                <thead>
                    </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // Data global yang akan diisi setelah pengunggahan CSV
        let globalData = [];
        let filteredData = [];
        const chartInstances = {}; // Untuk menyimpan instance Chart.js

        // Inisialisasi Chart.js
        document.addEventListener('DOMContentLoaded', () => {
            // Placeholder saat belum ada data
            document.getElementById('produksi-total').textContent = 'Unggah Data';
            document.getElementById('penjualan-total').textContent = 'Unggah Data';
            document.getElementById('area-total').textContent = 'Unggah Data';
            document.getElementById('harga-rata').textContent = 'Unggah Data';

            // Inisialisasi Chart.js dengan data kosong
            createCharts([]);
        });

        // Event listener untuk pengunggahan file
        document.getElementById('csvFileInput').addEventListener('change', handleFileUpload);
        
        // Event listener untuk filter bulan
        document.getElementById('filterBulan').addEventListener('change', applyFilters);

        // Event listener untuk pencarian tabel
        document.getElementById('tableSearch').addEventListener('keyup', filterTable);

        // Event listener untuk tombol unduh
        document.getElementById('downloadBtn').addEventListener('click', downloadData);

        // Fungsi untuk menangani unggahan file
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Memastikan nama kolom sesuai (Bulan/Periode, Produksi, Penjualan, Area, Harga, Lokasi)
                        globalData = results.data.map(item => ({
                            periode: item.Periode || item.Bulan, // Gunakan Periode atau Bulan
                            produksi: parseFloat(item.Produksi) || 0, // Dalam Ton
                            penjualan: parseFloat(item.Penjualan) || 0, // Dalam Rupiah
                            area: parseFloat(item.Area) || 0, // Dalam Hektar (Ha)
                            harga: parseFloat(item.Harga) || 0, // Harga per Kg
                            lokasi: item.Lokasi || 'Umum'
                        }));
                        
                        if (globalData.length > 0) {
                            document.getElementById('downloadBtn').disabled = false;
                            populateFilters(globalData);
                            applyFilters(); // Terapkan filter ke data awal (Semua)
                            alert(`Data berhasil diunggah! Total ${globalData.length} baris.`);
                        } else {
                            alert('Gagal memproses data atau file kosong.');
                        }
                    },
                    error: function(error) {
                        alert('Error saat parsing file CSV: ' + error.message);
                    }
                });
            }
        }

        // Fungsi untuk mengisi opsi filter bulan
        function populateFilters(data) {
            const select = document.getElementById('filterBulan');
            select.innerHTML = '<option value="">Semua</option>';
            const uniquePeriods = [...new Set(data.map(item => item.periode))].sort();
            uniquePeriods.forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                option.textContent = period;
                select.appendChild(option);
            });
            select.disabled = false;
        }

        // Fungsi untuk menerapkan filter
        function applyFilters() {
            const filterBulan = document.getElementById('filterBulan').value;
            
            filteredData = globalData.filter(item => {
                let match = true;
                if (filterBulan && item.periode !== filterBulan) {
                    match = false;
                }
                return match;
            });

            updateDashboard(filteredData);
        }

        // Fungsi utama untuk memperbarui seluruh dashboard
        function updateDashboard(data) {
            updateKpis(data);
            updateTable(data);
            createCharts(data);
            // Reset pencarian tabel
            document.getElementById('tableSearch').value = ''; 
            filterTable();
        }

        // Fungsi untuk memperbarui KPI (Kartu Metrik Utama)
        function updateKpis(data) {
            const totalProduksi = data.reduce((sum, item) => sum + item.produksi, 0);
            const totalPenjualan = data.reduce((sum, item) => sum + item.penjualan, 0);
            const totalArea = data.reduce((sum, item) => sum + item.area, 0);
            const rataHarga = data.length > 0 ? data.reduce((sum, item) => sum + item.harga, 0) / data.length : 0;

            document.getElementById('produksi-total').textContent = formatNumber(totalProduksi.toFixed(2)) + ' T';
            document.getElementById('penjualan-total').textContent = formatCurrency(totalPenjualan);
            document.getElementById('area-total').textContent = formatNumber(totalArea.toFixed(2)) + ' Ha';
            document.getElementById('harga-rata').textContent = formatCurrency(rataHarga.toFixed(2), 0) + '/Kg';
        }

        // Fungsi untuk memperbarui Tabel Data
        function updateTable(data) {
            const tableBody = document.querySelector('#data-table tbody');
            const tableHead = document.querySelector('#data-table thead');
            tableBody.innerHTML = '';
            tableHead.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Tidak ada data untuk ditampilkan.</td></tr>';
                return;
            }

            // Header Tabel
            const headers = ['Periode', 'Produksi (Ton)', 'Penjualan (Rp)', 'Area (Ha)', 'Harga (Rp/Kg)', 'Lokasi'];
            tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h} <i class="fas fa-sort"></i></th>`).join('')}</tr>`;

            // Baris Tabel
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.periode}</td>
                    <td>${formatNumber(item.produksi.toFixed(2))}</td>
                    <td>${formatCurrency(item.penjualan, 0)}</td>
                    <td>${formatNumber(item.area.toFixed(2))}</td>
                    <td>${formatCurrency(item.harga.toFixed(2), 0)}</td>
                    <td>${item.lokasi}</td>
                `;
            });
        }
        
        // Fungsi untuk membuat / memperbarui semua grafik
        function createCharts(data) {
            // Hancurkan instance chart yang sudah ada
            Object.values(chartInstances).forEach(chart => chart.destroy());

            if (data.length === 0) {
                // Tampilkan pesan kosong di canvas jika tidak ada data
                Object.keys(chartInstances).forEach(id => {
                    const ctx = document.getElementById(id).getContext('2d');
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = '16px Arial';
                    ctx.fillStyle = 'var(--teks-gelap)';
                    ctx.textAlign = 'center';
                    ctx.fillText('Unggah atau Filter Data', ctx.canvas.width / 2, ctx.canvas.height / 2);
                });
                return;
            }

            // --- Persiapan Data Grafik ---
            
            // Pengelompokan Data Tren Waktu (Garis)
            const groupedByPeriod = data.reduce((acc, item) => {
                acc[item.periode] = acc[item.periode] || { totalProduksi: 0, totalHarga: 0, count: 0 };
                acc[item.periode].totalProduksi += item.produksi;
                acc[item.periode].totalHarga += item.harga;
                acc[item.periode].count += 1;
                return acc;
            }, {});

            const labelsLine = Object.keys(groupedByPeriod).sort();
            const dataProduksiLine = labelsLine.map(k => groupedByPeriod[k].totalProduksi);
            const dataHargaLine = labelsLine.map(k => groupedByPeriod[k].totalHarga / groupedByPeriod[k].count);
            
            // Pengelompokan Data Penjualan per Lokasi (Batang)
            const groupedByLocation = data.reduce((acc, item) => {
                acc[item.lokasi] = (acc[item.lokasi] || 0) + item.penjualan;
                return acc;
            }, {});
            const labelsBar = Object.keys(groupedByLocation);
            const dataPenjualanBar = labelsBar.map(k => groupedByLocation[k]);

            // Pengelompokan Data Area (Lingkaran/Pie)
            const groupedByArea = data.reduce((acc, item) => {
                acc[item.lokasi] = (acc[item.lokasi] || 0) + item.area;
                return acc;
            }, {});
            const labelsPie = Object.keys(groupedByArea);
            const dataAreaPie = labelsPie.map(k => groupedByArea[k]);
            const backgroundColorsPie = generateColors(labelsPie.length);


            // --- Chart Garis: Tren Produksi dan Harga ---
            const ctxLine = document.getElementById('lineChart').getContext('2d');
            chartInstances.lineChart = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: labelsLine,
                    datasets: [
                        {
                            label: 'Produksi (Ton)',
                            data: dataProduksiLine,
                            borderColor: varToRgb('--hijau-primer'),
                            backgroundColor: 'rgba(0, 112, 65, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        },
                        {
                            label: 'Harga Rata-rata (Rp/Kg)',
                            data: dataHargaLine,
                            borderColor: varToRgb('--hijau-aksen'),
                            backgroundColor: 'rgba(139, 195, 74, 0.2)',
                            yAxisID: 'y2',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Produksi (Ton)',
                                color: varToRgb('--hijau-primer')
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false, // Hanya tampilkan grid untuk y1
                            },
                            title: {
                                display: true,
                                text: 'Harga (Rp/Kg)',
                                color: varToRgb('--hijau-aksen')
                            }
                        }
                    }
                }
            });

            // --- Chart Batang: Perbandingan Penjualan per Lokasi ---
            const ctxBar = document.getElementById('barChart').getContext('2d');
            chartInstances.barChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labelsBar,
                    datasets: [{
                        label: 'Total Penjualan (Rp)',
                        data: dataPenjualanBar,
                        backgroundColor: varToRgb('--hijau-sekunder', 0.8),
                        borderColor: varToRgb('--hijau-primer'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Penjualan (Rp)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value, 0, false); // Tampilkan nilai uang
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y, 0, true);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // --- Chart Lingkaran: Distribusi Area ---
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            chartInstances.pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: labelsPie,
                    datasets: [{
                        data: dataAreaPie,
                        backgroundColor: backgroundColorsPie,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatNumber(context.parsed.toFixed(2)) + ' Ha';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fungsi untuk memfilter tabel berdasarkan input pencarian
        function filterTable() {
            const input = document.getElementById('tableSearch');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('data-table');
            const tr = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

            for (let i = 0; i < tr.length; i++) {
                let showRow = false;
                const td = tr[i].getElementsByTagName('td');
                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        if (td[j].textContent.toLowerCase().indexOf(filter) > -1) {
                            showRow = true;
                            break;
                        }
                    }       
                }
                tr[i].style.display = showRow ? '' : 'none';
            }
        }

        // Fungsi untuk mengunduh data yang difilter sebagai CSV
        function downloadData() {
            if (filteredData.length === 0) {
                alert("Tidak ada data untuk diunduh.");
                return;
            }
            const csv = Papa.unparse(filteredData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `data_kelapa_sawit_filtered_${document.getElementById('filterBulan').value || 'semua'}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // --- Fungsi Utilitas ---

        // Konversi variabel CSS ke string RGBA
        function varToRgb(cssVar, opacity = 1) {
            const color = getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim();
            // Asumsi format HEX untuk kemudahan
            if (color.startsWith('#')) {
                let hex = color.slice(1);
                if (hex.length === 3) hex = hex.split('').map(h => h + h).join('');
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            return color; // Kembalikan nilai jika bukan hex
        }

        // Fungsi untuk menghasilkan warna cerah untuk Pie Chart
        function generateColors(count) {
            const colors = [
                '#007041', '#4CAF50', '#8BC34A', '#CDDC39', '#FFC107', 
                '#FF9800', '#FF5722', '#F44336', '#E91E63', '#9C27B0'
            ];
            const result = [];
            for(let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        // Fungsi format Rupiah (tanpa simbol Rp)
        function formatCurrency(number, decimal = 2, includeRp = true) {
            const num = parseFloat(number);
            if (isNaN(num)) return 'N/A';
            const formatted = num.toLocaleString('id-ID', { minimumFractionDigits: decimal, maximumFractionDigits: decimal });
            return (includeRp ? 'Rp ' : '') + formatted;
        }

        // Fungsi format Angka
        function formatNumber(number) {
            const num = parseFloat(number);
            if (isNaN(num)) return 'N/A';
            return num.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    </script>
</body>
</html>